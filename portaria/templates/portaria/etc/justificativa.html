{% extends 'base.html' %}
{% block content %}
{% load groupscheck %}
{% if request.user|has_group:"justificativas" %}
<style>
    .smallcap td{
        font-size:11px;
    }
</style>
        <div class="container mt-5">
            {% for message in messages %}
            <div class="container-fluid p-0">
                <div class="alert {{ message.tags }} alert-dismissible" role="alert">
                    {{ message }}
                </div>
            </div>
            {% endfor %}
            <div class="row linha-baixo">
                <h2 class="title-cad col-6">Quantidade</h2>
                <div class="col-6">
                    <form method="get">
                    <label for="dates">Período:</label>
                    <input type="date" name="data1" id="dates">
                    <input type="date" name="data2">
                    <label for="filial">Filial:</label>
                    <select name="filial" id="filial">
                        <option></option>
                        {% for t,p in gachoices %}
                            <option value="{{ t }}">{{ p }}</option>
                        {% endfor %}
                    </select>
                    <button type="submit">Filtrar</button>
                    </form>
                </div>
            </div>
            <div class="row" style="margin-left: 6rem;">
            <form method="post" id="formgroup">{% csrf_token %}
            <table class="table">
                <thead>
                <tr>
                    <th>CTE</th>
                    <th>Emissão</th>
                    <th>Remetente</th>
                    <th>Destinatário</th>
                    <th>Peso</th>
                    <th>LeadTime</th>
                    <th>Em Aberto</th>
                    <th>Entrega</th>
                    <th>Nota Fiscal</th>
                    <th>Justificativa</th>
                </tr>
                </thead>
                <tbody>

                {% for f in form %}
                    <tr class="smallcap">

                        <td>{{ f.conhecimento }}</td>
                        <td>{{ f.data_emissao }}</td>
                        <td>{{ f.remetente }}</td>
                        <td>{{ f.destinatario }}</td>
                        <td>{{ f.peso }}</td>
                        <td>{{ f.lead_time }}</td>
                        <td>{{ f.em_aberto }}</td>
                        <td>{{ f.local_entreg }}</td>
                        <td>{{ f.nota_fiscal }}</td>
                        <td><select name="ocor" style="font-size:10px;">
                            {% for k,v in justchoices %}
                            <option value="{{ k }}">{{ v }}</option>
                            {% endfor %}
                            </select>
                            <input type="hidden" name="idobj" value="{{ f.id }}">
                        </td>
                        <td><button type="button" id="myBtn" value="{{ forloop.counter }}"><ion-icon name="list"></ion-icon></button></td>
                    </tr>
                        <div id="myModal{{ forloop.counter }}" class="modal">
                            <div class="modal-content">
                                <div>
                                    <span class="title-cad">Ocorrências</span>
                                    <span class="close col">&times;</span>
                                </div>
                                <div class="container tktcontainer">
                                    {% if f.ocorrenciaentrega_set.all %}
                                    <ul>
                                    {% for q in f.ocorrenciaentrega_set.all %}
                                        <li><p style="margin: 0 0 0 0;">Descrição: <strong>{{ q.desc_ocor }}</strong> -
                                            Data:<strong>{{ q.data_ocorrencia }}</strong></p></li>
                                    {% endfor %}
                                    </ul>
                                    {% else %}
                                        <p style="margin: 0 0 0 0;">Nenhuma ocorrencia encontrada.</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                {% endfor %}
                </tbody>
            </table>
            </form>
                <button class="col-1" type="button" id="bot">Lançar</button>
            </div>
        </div>
{% else %}<p>Usuário não tem permissão para acessar</p>{% endif %}
<script>
    $(document).ready(function(){
        $("button").click(function(){
            var btn = $(this);
            var but = $(this).val();
            console.log(but)
            console.log(btn)
            var modal = document.getElementById("myModal"+but);
            var span = modal.getElementsByClassName("close")[0];
            modal.style.display = "block";

            span.onclick = function() {
                modal.style.display = "none";
            };
            window.onclick = function(event) {
                if (event.target == modal){
                    modal.style.display = "none";
                }
            };
        });
    });
</script>
<script>
    $(document).ready(function(){
        var array = []
        var botao = document.getElementById('bot');
        $(botao).click(function (){
            var data = document.getElementsByName('ocor');
            var data2 = document.getElementsByName('idobj');
            if(data.length == data2.length){
                for(i=0; data[i]; i++){
                    var toinsert = {'id':data2[i].value,'ocorr':data[i].value}
                    array.push(toinsert)
                }
                console.log(array)
                $.ajax({
                    type: "POST",
                    url: "{% url 'portaria:justificativa' %}",
                    headers: {
                        "X-CSRFToken": "{{ csrf_token }}"
                    },
                    data: {'vals':JSON.stringify(array)},
                    success: function (msg){
                             if(msg == 200){
                                location.reload();
                             }},
                    error: function (err)
                            { alert(err.responseText)}
                });
            }else{
                console.log('erro dados diferem');
            };
        });
    });
</script>
{% endblock %}