{% extends 'base.html' %}
{% block content %}
{% load static %}
{% load groupscheck %}
{% if request.user|has_group:"compras" %}
<style>
    input[type="file"]{
        display:block;
        border-radius:0;
    }
    .form-label{
        font-size: clamp(14px, 1.6rem, 2vw);
        font-weight: 600;
    }
    .form-control{
        margin: 0 0 10px 0;
    }
    .selector-option{
        font-size: 1.6rem;
    }
    .wrapper{
        width: 100%;
        display: flex;
        
    }
    .form{
        width: 40%;
        padding: 10px;
        
        background-color: yellow;
    }
    .message-box{
        width: 60%;

        background-color: violet;
    }
</style>
    <div class="container mt-4">
        {% for message in messages %}
            <div class="container-fluid p-0">
                <div class="alert {{ message.tags }} alert-dismissible" role="alert">
                    {{ message }}
                </div>
            </div>
        {% endfor %}
        <h1>Funções<hr></h1>
        <div>
            <h2><b>Solicitação nº {{ obj.nr_solic }}</b></h2>
        </div>
        <div class="wrapper">
            <div class="form">
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div style="display: flex; justify-content: space-between;">
                        <div class="form-group" style="width: 48%;">
                            <label class="form-label" for="status">Status *</label>
                            <select class="form-control" id="status" name="status">
                                <option class="selector-option" label="{{ obj.status|default_if_none:'Não Cadastrado' }}"></option>
                                {% for k,v in stschoices %}
                                <option class="selector-option" value="{{ k }}"> {{ v }} </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group" style="width: 48%;">
                            <label class="form-label" for="filial">Filial *</label>
                            <select class="form-control" id="filial" name="filial">
                                <option class="selector-option"  label="{{ obj.get_filial_display|default_if_none:'Não Cadastrado' }}"></option>
                                {% for k,v in gachoices %}
                                <option class="selector-option"  value="{{ v }}">{{ v }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <div class="form-group" style="width: 48%;">
                            <label class="form-label" for="status">Departamento *</label>
                            <select class="form-control" id="status" name="status">
                                <option class="selector-option" label="{{ obj.departamento|default_if_none:'Não Cadastrado' }}"></option>
                                {% for k,v in dpchoices %}
                                <option class="selector-option" value="{{ k }}"> {{ v }} </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group" style="width: 48%;">
                            <label class="form-label" for="filial">Responsável *</label>
                            <select class="form-control" id="filial" name="filial">
                                <option class="selector-option"  label="{{ obj.responsavel|default_if_none:'Não Cadastrado' }}"></option>
                                {% for q in rpchoices %}
                                <option class="selector-option"  value="{{ q.id }}">{{ q.username }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <div class="form-group" style="width: 48%;">
                            <label class="form-label" for="status">Categoria *</label>

                            <select class="form-control" id="categoria" name="categoria" onchange="DisplayInput();">
                                <option class="selector-option" label="{{ obj.categoria }}">{{ obj.categoria }}</option>
                                <option class="selector-option" label="ALMOXARIFADO">ALMOXARIFADO</option>
                                <option class="selector-option" label="COTAÇÃO">COTAÇÃO</option>
                                <option class="selector-option" label="NOTA FISCAL">NOTA FISCAL</option>
                            </select>
                        </div>
                        <div class="form-group" style="width: 48%;">
                            <label class="form-label" for="filial">Prazo</label>
                            <select class="form-control" id="filial" name="filial">
                                <option class="selector-option"  label="{{ obj.prazo_conclusao|default_if_none:'Não Cadastrado' }}"></option>
                                {% for k,v in gachoices %}
                                <option class="selector-option"  value="{{ v }}">{{ v }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="solicitante">Solicitante</label>
                        <div style="display: flex;">
                            <input style="
                                margin: 0;
                                padding: 1rem;
                                border-radius: 0.8rem 0 0 0.8rem ;
                                border-right: none;
                            " 
                            value="{{ obj.solicitante|default_if_none:'Não Cadastrado' }}" type="text" class="form-control" id="solicitante" aria-describedby="emailHelp" placeholder="Você não deveria estar vendo isso..." readonly>
                            <a
                            href="mailto:{{obj.email_solic}}"
                            class="button" 
                            style="
                                margin: 0;
                                padding: 1rem;
                                border-radius: 0 0.8rem 0.8rem 0 ;
                            "
                            type="button"  
                            ><ion-icon style="margin-top: -0.125em" name="mail-outline"></ion-icon>
                            </a>
                        </div>
                        <small id="emailHelp" class="form-text text-muted">Pressione o botão para enviar um email ao solicitante.</small>
                      </div>
                </form>
            </div>
            <div class="message-box">
                asd
            </div>
        </div>

        <div class="container viewmonit">
            <div class="tktcontainer">
                <form method="post" enctype="multipart/form-data">{% csrf_token %}
                <div class="row">
                    <div class="col-4">
                    <h2>Solicitação nº {{ obj.nr_solic }}</h2>
                    <ul>
                        <li><div>Status:
                        <select name="status">
                            <option label="{{ obj.status|default_if_none:'Não Cadastrado' }}"></option>
                            {% for k,v in stschoices %}
                            <option value="{{ k }}">{{ v }}</option>
                            {% endfor %}
                        </select></div></li>
                        <li><div>Filial:
                        <select name="filial">
                            <option label="{{ obj.get_filial_display|default_if_none:'Não Cadastrado' }}"></option>
                            {% for k,v in gachoices %}
                            <option value="{{ v }}">{{ v }}</option>
                            {% endfor %}
                        </select></div></li>
                        <li><div>Departamento:
                            <select name="departamento">
                            <option label="{{ obj.departamento|default_if_none:'Não Cadastrado' }}"></option>
                            {% for k,v in dpchoices %}
                            <option value="{{ k }}">{{ v }}</option>
                            {% endfor %}
                        </select></div></li>
                        <li><div>Responsável:
                        <select name="responsavel">
                            <option label="{{ obj.responsavel|default_if_none:'Não Cadastrado' }}"></option>
                            {% for q in rpchoices %}
                            <option value="{{ q.id }}">{{ q.username }}</option>
                            {% endfor %}
                        </select></div></li>
                        <li><div>Categoria:
                        <select name="categoria" id="categoria" onchange="DisplayInput();">
                            <option label="{{ obj.categoria }}">{{ obj.categoria }}</option>
                            <option label="ALMOXARIFADO">ALMOXARIFADO</option>
                            <option label="COTAÇÃO">COTAÇÃO</option>
                            <option label="NOTA FISCAL">NOTA FISCAL</option>
                        </select></div></li>
                        {% if not obj.prazo_conclusao %}<li><div><label for="prazo_conclusao">Prazo:</label>
                            <input type="date" readonly id="prazo_conclusao" name="prazo_conclusao"></div></li>
                        {% else %}
                            <li><div><label for="criado_em">Criado em:</label>
                            <input type="text" readonly id="criado_em" value="{{ obj.pub_date }}"></div></li>
                        {% endif %}
                        {% if not obj.dt_vencimento %}
                            <div id="display_dt_venc" style="display:none;">
                                <li>
                                    <label for="dt_venc">Vencimento:</label>
                                    <input type="date" id="dt_venc" name="dt_venc">
                                </li>
                            </div>
                        {% elif vencimento > 0 %}
                            <li>
                                <div>
                                    <p>O boleto vai vencer em <b>{{ vencimento }}</b> dias</P>
                                </div>
                            </li>
                        {% elif vencimento < 0 %}
                            <li>
                                <div>
                                    <p>O boleto venceu faz <b>{{ vencimento|invert }}</b>  dias</p>
                                </div>
                            </li>
                        {% else %}
                            <li>
                                <div>
                                    <p>O boleto vence <b>hoje</b></P>
                                </div>
                            </li>
                        {% endif %}
                        <li><div>Solicitante: {{ obj.solicitante|default_if_none:'Não Cadastrado' }} </div></li>
                        <li><div style="word-wrap: break-word;">Anexo: {% if obj.anexo %}<a href="/media/{{ obj.anexo }}" download>{{ obj.anexo|filename }}</a>
                            {% else %} nenhum anexo. {% endif %}
                        </div></li>
                        <li>
                            <div style="word-wrap: break-word;">
                                {% if obj.pago %}
                                    Solicitação paga
                                {% else %}
                                    Aguardando pagamento
                                {% endif %}
                            </div>
                        </li>
                        <li><div><h3>Observação:</h3>
                            <textarea rows="3" cols="30" id="obs" name="obs" style="border:solid 1px;">{% if obj.obs %}{{ obj.obs }}{% endif %}</textarea></div></li>
                    </ul>
                    </div>

                    <div class="col-8">
                    {% if request.user|has_group:'compras-adm' %}
                        <h2>Cadastrar entradas</h2>
                            <input type="hidden" name="obj_id" value="{{ obj.id }}">
                            <div class="col">
                                {{ editor.area|safe }}
                            </div>
                            <div class="col-2" style="margin-left:2rem;">
                                <input type="file" name="file" multiple="" id="id_file">
                            </div>
                    {% endif %}
                    </div>

                        <div style="width:55%">
                            {% if obj.status == 'CONCLUIDO'%}
                                <button style="float:right;max-width:10rem;margin-top:1rem;" type="submit" name="pago" value="1" {% if obj.pago %}disabled{% endif %}>Pago</button>

                            {% endif %}
                            <button style="float:right;max-width:10rem;margin-top:1rem;" type="submit">Atualizar</button>
                        </div>

                </div>
                </form>
                <hr>
                <h2>Lista de itens</h2>
                <ul>
                    {% for q in obj.produtossolicitacoes_set.all %}
                        <li>{{ q.produto }} - {{ q.qnt_itens }}un </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        <div class="container viewmonit">
            <div class="tktcontainer">
                <h2>Entradas</h2>
                <hr>
                <div class="row">
                    {% if entradas %}
                        {% for q in entradas %}
                            <div class="container createboxes">
                                <ul>
                                    <li>ID entrada: {{ q.id }}</li>
                                    <li>Observação: {{ q.obs|safe }}</li>
                                    {% if q.file1 %}<li><a href="/media/{{ q.file1 }}" download>{{ q.file1|filename }}</a></li>{% endif %}
                                    {% if q.file2 %}<li><a href="/media/{{ q.file2 }}" download>{{ q.file2|filename }}</a></li>{% endif %}
                                    {% if q.file3 %}<li><a href="/media/{{ q.file3 }}" download>{{ q.file3|filename }}</a></li>{% endif %}
                                </ul>
                            </div>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
{% else %}<p>Usuário não tem permissão para acessar</p>{% endif %}
<script>
    var input = document.getElementById('id_file')
    input.addEventListener('change', (e) =>{
        const files = input.files;
        if(files.length > 3){
            alert('Máximo de 3 arquivos permitidos.')
            input.value = ''
        }
    });
</script>
<script>
    function DisplayInput(){
        key = document.getElementById('categoria');
        switchkey = key.options[key.selectedIndex].label
        if(switchkey == 'NOTA FISCAL'){
            document.getElementById('display_dt_venc').style.display = "block";
        }else{
            document.getElementById('display_dt_venc').style.display = "none";
            }
        lklk = document.getElementById('prazo_conclusao').value = getPrazo(switchkey);
        };

    function getPrazo(e){
        if(e == 'ALMOXARIFADO' || e == 'NOTA FISCAL'){
            plusdays = 5
        } else{
            plusdays = 10
        }
        result = new Date();
        result.setDate(result.getDate() + plusdays);
        while(result.getDay() == '0' || result.getDay() == '6' ){
            result.setDate(result.getDate() + 1)
        }
        return result.toLocaleDateString('en-CA');
    }
</script>
{% endblock %}